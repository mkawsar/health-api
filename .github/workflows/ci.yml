name: CI

on:
  push:
  pull_request:

jobs:
  check:
    name: Format & DB connection
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval \"db.adminCommand('ping')\""
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache-dependency-path: go.sum

      - name: Code format
        run: |
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "Run: gofmt -w ."
            echo "$unformatted"
            exit 1
          fi

      - name: Dependencies
        run: go mod download

      - name: Config for CI
        run: cp .env.example .env

      - name: DB connection
        env:
          SERVER_ADDR: "0.0.0.0"
          SERVER_PORT: "8080"
          MONGO_URI: "mongodb://localhost:27017"
          MONGO_DATABASE: "health_ci"
          USE_REDIS: "false"
          JWT_SECRET: "ci-secret"
          JWT_ACCESS_EXPIRATION_MINUTES: "15"
          JWT_REFRESH_EXPIRATION_DAYS: "7"
          MODE: "release"
        run: |
          go run main.go &
          sleep 5
          curl -sf http://localhost:8080/v1/ping || exit 1
          pkill -f "go run main.go" || true
