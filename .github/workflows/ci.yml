name: CI

on:
  push:
  pull_request:

jobs:
  check:
    name: Format & DB connection
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval \"db.adminCommand('ping')\""
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache-dependency-path: go.sum

      - name: Code format
        run: |
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "Run: gofmt -w ."
            echo "$unformatted"
            exit 1
          fi

      - name: Dependencies
        run: go mod download

      - name: Build
        run: go build -o health-api main.go

      - name: Config for CI
        run: |
          cat > .env << 'EOF'
          SERVER_ADDR=0.0.0.0
          SERVER_PORT=8080
          MONGO_URI=mongodb://localhost:27017
          MONGO_DATABASE=health_ci
          USE_REDIS=false
          REDIS_DEFAULT_ADDR=localhost:6379
          JWT_SECRET=ci-secret
          JWT_ACCESS_EXPIRATION_MINUTES=15
          JWT_REFRESH_EXPIRATION_DAYS=7
          MODE=release
          EOF

      - name: DB connection
        run: |
          ./health-api > app.log 2>&1 &
          pid=$!
          sleep 3
          echo "--- app log (first 3s) ---"
          cat app.log || true
          for i in $(seq 1 12); do
            if curl -sf http://localhost:8080/v1/ping; then
              echo "DB connection OK"
              kill $pid 2>/dev/null || true
              exit 0
            fi
            sleep 1
          done
          echo "App failed to start. Log:"
          cat app.log || true
          kill $pid 2>/dev/null || true
          exit 1
